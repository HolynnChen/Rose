<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="/static/ftpmanager/css/normalize.css">
    <link href="https://cdn.bootcss.com/element-ui/2.5.4/theme-chalk/index.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/static/ftpmanager/css/main.css">
    <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_1055306_fir40j9usx7.css">
    <script src="https://cdn.bootcss.com/vue/2.6.4/vue.min.js"></script>
    <script src="https://cdn.bootcss.com/element-ui/2.5.4/index.js"></script>
    <script type="text/javascript" src="/static/ftpmanager/js/main.js"></script>
    <meta charset="UTF-8">
    <title>FtpManager管理页面</title>
</head>

<body>
    <div class="main" id="main_app">
        <div class="main_header">
            <img src="/static/ftpmanager/img/logo.png">
            <p>FtpManager管理系统</p>
        </div>
        <div class="main_body">
            <div class="main_body_menu">
                <el-menu class="main_menu" :collapse="menu.isCollapse" default-active="1" @select="change_page">
                    <el-menu-item index="1">
                        <i class="el-icon-menu"></i>
                        <span slot="title">主菜单</span>
                    </el-menu-item>
                    <el-menu-item index="2">
                        <i class="el-icon- iconfont icon-user"></i>
                        <span slot="title">用户管理</span>
                    </el-menu-item>
                    <el-menu-item index="3">
                        <i class="el-icon- iconfont icon-key"></i>
                        <span slot="title">退出系统</span>
                    </el-menu-item>
                    <el-menu-item index="9" @click="menu_toggle">
                        <i :class="{'el-icon-caret-bottom':menu.isCollapse,'el-icon-caret-top':!menu.isCollapse}"></i>
                        <span slot="title">{{menu.isCollapse?"展开":"收起"}}</span>
                    </el-menu-item>
                </el-menu>
            </div>
            <div class="main_body_content">
                <div class="main_app_index" v-show="app.page==1">
                    <div class="index_top_bar">
                        <p>服务器状态总览({{app.connect?'自动同步中':'连接已断开'}})</p>
                    </div>
                    <div class="main_app_container">
                        <div class="index_status">
                            <el-card class="index_card">
                                <div slot="header">
                                    <i class="el-icon-tickets"></i>
                                    <span>接入服务器数量</span>
                                </div>
                                <div>
                                    <p>在线：{{server_status_filter(1).length}}台</p>
                                    <p>离线：{{server_status_filter(0).length}}台</p>
                                    <p>异常：{{server_status_filter(2).length}}台</p>
                                </div>
                            </el-card>
                            <el-card class="index_card">
                                <div slot="header">所有服务器列表</div>
                                <div>
                                    <el-collapse>
                                        <el-collapse-item v-for="server in server_by_status" :title="server.name.slice(0,35)+(server.name.length>35?'...':'')">
                                            <div class="server_status">
                                                <p class="inner_top">服务器状态</p>
                                                <p class="inner_body">{{['离线','在线','异常'][server.status]}}</p>
                                            </div>
                                            <div class="server_disk">
                                                <p class="inner_top">磁盘占用情况</p>
                                                <div class="server_disk_list"
                                                    v-for="(disk,name) in server.more.disk_info">
                                                    <div class="server_disk_bar"
                                                        :style="{background: 'linear-gradient(to right,#7BA23F 0%,#7BA23F '+disk[3]+'%,#ffffff '+disk[3]+'%,#ffffff 100%)'}"
                                                        :title="toGB(disk[1])+'GB/'+toGB(disk[0])+'GB'">目录:{{name}}
                                                    </div>
                                                    <div class="server_disk_occupy">占用:{{disk[3]}}%</div>
                                                </div>
                                            </div>
                                        </el-collapse-item>
                                    </el-collapse>
                                </div>
                            </el-card>
                        </div>
                        <div class="index_setting">
                            <el-card class="index_card">
                                <div slot="header">
                                    <i class="el-icon-setting"></i>
                                    <span>服务器信息配置</span>
                                    <div class="index_setting_select">
                                        <el-select v-model="app.index.changeinfo.server_id" placeholder="请选择">
                                            <el-option-group v-for="(servers,index) in sorted_service" :key="index"
                                                :label="['在线','离线','异常'][index]">
                                                <el-option v-for="server in servers" :label="server.name"
                                                    :value="server.server_id"></el-option>
                                            </el-option-group>
                                        </el-select>
                                    </div>
                                </div>
                                <div v-if="app.index.changeinfo.server_id">
                                    <div class="index_form">
                                        <el-form :inline="true">
                                            <el-form-item>
                                                <el-input v-model="app.index.changeinfo.data"
                                                    placeholder="修改名字，3-15字之间"></el-input>
                                            </el-form-item>
                                            <el-form-item>
                                                <el-button type="primary" round
                                                    @click="app.index.changeinfo.flag && changename()">确认</el-button>
                                            </el-form-item>
                                        </el-form>
                                        <div class="index_button">
                                            <el-button
                                                :disable="app.index.servers_dict[app.index.changeinfo.server_id].status==1"
                                                type="danger" round @click="delete_server">删除服务器</el-button>
                                            <el-button type="info" round @click="clear_index">取消所有操作</el-button>
                                        </div>
                                    </div>
                                </div>
                            </el-card>
                        </div>
                    </div>
                </div>
                <div class="main_app_user" v-show="app.page==2">
                    <div class="user_top_bar">
                        <p>服务器用户总览({{app.connect?'自动同步中':'连接已断开'}})</p>
                    </div>
                    <div class="main_app_container">
                        <div class="user_status">
                            <el-card class="user_card">
                                <div slot="header">用户数量统计</div>
                                <div>
                                    <p>用户总数：{{app.user.users.all}}</p>
                                    <div v-for="(num,server) in app.user.users.servers" class="all_count">
                                        <p>服务器名：{{app.index.servers_dict[server].name}}</p>
                                        <p>开通人数：{{num}}</p>
                                    </div>
                                </div>
                            </el-card>
                        </div>
                        <div class="user_manage">
                            <el-card class="user_card">
                                <div slot="header" class="header">
                                    <div>用户管理</div>
                                    <transition name="user_change">
                                        <el-button v-if="!app.user.select_user && !app.user.add.user" type="primary" size="mini" @click="app.user.add.user=true,app.user.select_user={user_info:{},user_dbnote:[]},app.user.select_user_bak={user_info:{},user_dbnote:[]}">添加用户</el-button>
                                    </transition>
                                </div>
                                <transition name="user_change" mode="out-in">
                                    <div class="user_manage_query" v-if="!app.user.select_user && !app.user.add.user" key="top">
                                        <div class="user_manage_query_search">
                                            <el-cascader class="search_a" :options="app.user.servers" :props="app.user.search_props" @change="load_dbnote" change-on-select clearable></el-cascader>
                                            <el-input class="search_b" placeholder="用户名或邮箱" v-model="app.user.search_user.user_keyword" @input.native="get_users" @clear="get_users" clearable>
                                            </el-input>
                                        </div>
                                        <el-table :data="app.user.userlist" highlight-current-row @current-change="get_user" v-loading="app.user.loading.user_loading">
                                            <el-table-column prop="user_id" label="ID" min-width="20%"></el-table-column>
                                            <el-table-column prop="name" label="姓名" min-width="30%"></el-table-column>
                                            <el-table-column prop="mail" label="邮箱" min-width="50%"></el-table-column>
                                        </el-table>
                                    </div>
                                    <div class="user_selected_manage" v-else key="user_form">
                                        <el-form v-model="app.user.select_user">
                                            <el-form-item label="用户名">
                                                <el-input v-model="app.user.select_user.user_info.name" placeholder="请输入用户名" clearable></el-input>
                                            </el-form-item>
                                            <el-form-item label="用户邮箱">
                                                <el-input v-model="app.user.select_user.user_info.mail" placeholder="请输入用户邮箱" clearable></el-input>
                                            </el-form-item>
                                            <el-form-item :label="app.user.add.user?'用户密码':'重置密码'">
                                                <el-input v-model="app.user.select_user.user_info.password" :placeholder="app.user.add.user?'请输入用户密码':'留空不修改'" show-password></el-input>
                                            </el-form-item>
                                            <el-form-item label="当前标签">
                                                <br>
                                                <el-tag v-for="tag in app.user.select_user.user_dbnote" closable size="small" :key="tag" @close="user_update().remove_tag(tag)">{{tag.name}}</el-tag>
                                                <el-button size="mini" round @click="app.user.user_tag_dialog.see=true">增加标签</el-button>
                                            </el-form-item>
                                            <el-dialog title="选择标签" :visible.sync="app.user.user_tag_dialog.see" width="fit-content">
                                                <el-cascader v-model="app.user.user_tag_dialog.value" :options="app.user.servers" :props="app.user.search_props" @active-item-change="load_dbnote" clearable></el-cascader>
                                                <el-button round type="success" @click="user_update().add_tag()">确认添加</el-button>
                                            </el-dialog>
                                        </el-form>
                                        <div class="button_container">
                                            <el-button size="small" round type="success" @click="user_update().change()">{{app.user.add.user?'确认添加':'确认修改'}}</el-button>
                                            <el-button size="small" v-if="!app.user.add.user" round type="danger" @click="user_update().remove()">删除用户</el-button>
                                            <el-button size="small" round type="warning" @click="user_update().default()">重置</el-button>
                                            <el-button size="small" round type="primary" @click="user_update().back()">取消</el-button>
                                        </div>
                                    </div>
                                </transition>
                            </el-card>
                        </div>
                        <div class="dbnote_manage">
                            <el-card class="user_card">
                                <div slot="header" class="header">
                                    <div>标签管理</div>
                                    <transition name="user_change">
                                        <el-button v-if="!app.user.select_dbnote && !app.user.add.dbnote" type="primary" size="mini" @click="app.user.add.dbnote=true,app.user.select_dbnote={permissions:[],more_config:[]},app.user.select_dbnote_bak={permissions:[],more_config:[]}">添加标签</el-button>
                                    </transition>
                                </div>
                                <transition name="user_change" mode="out-in">
                                    <div v-if="!app.user.select_dbnote && !app.user.add.dbnote">
                                        <div class="user_manage_query_search">
                                            <el-select class="search_a" v-model="app.user.search_dbnote.server_id" placeholder="可选择服务器" clearable @change="get_dbnotes">
                                                <el-option v-for="server in app.user.servers" :label="server.name" :value="server.server_id"></el-option>
                                            </el-select>
                                            <el-input class="search_b" v-model="app.user.search_dbnote.dbnote_keyword" placeholder="可输入关键词" clearable @input.native="get_dbnotes"></el-input>
                                        </div>
                                        <el-table :data="app.user.dbnotelist" highlight-current-row @current-change="get_dbnote" v-loading="app.user.loading.dbnote_loading">
                                            <el-table-column prop="id" label="ID" min-width="20%"></el-table-column>
                                            <el-table-column prop="server_name" label="所属服务器" min-width="40%"></el-table-column>
                                            <el-table-column prop="name" label="名称" min-width="40%"></el-table-column>
                                        </el-table>
                                        <!--<el-dialog title="修改信息" :visible.sync="app.user.dbnote_dialog.see" width="fit-content">
                                            <el-button round type="success" @click="">确认添加</el-button>
                                        </el-dialog>-->
                                    </div>
                                    <div v-else key="dbnote_form">
                                        <el-form>
                                            <el-form-item label="所属服务器">
                                                <el-select :disabled="!app.user.add.dbnote" v-model="app.user.select_dbnote.server_id">
                                                    <el-option v-for="server in app.user.servers" :label="server.name" :value="server.server_id"></el-option>
                                                </el-select>
                                            </el-form-item>
                                            <el-form-item label="标签名">
                                                <el-input v-model="app.user.select_dbnote.name"></el-input>
                                            </el-form-item>
                                            <el-form-item label="路径">
                                                <el-input v-model="app.user.select_dbnote.path"></el-input>
                                            </el-form-item>
                                            <el-form-item label="权限">
                                                <br>
                                                <el-checkbox-group v-model="app.user.select_dbnote.permissions">
                                                    <el-checkbox v-for="(value,key) in app.checkbox_group_value" :label="key">{{value}}</el-checkbox>
                                                </el-checkbox-group>
                                            </el-form-item>
                                            <el-form-item label="额外选项">
                                                <el-checkbox-group v-model="app.user.select_dbnote.more_config">
                                                    <el-checkbox label="用户独立目录"></el-checkbox>
                                                </el-checkbox-group>
                                            </el-form-item>
                                        </el-form>
                                        <div class="button_container">
                                            <el-button size="small" round type="success" @click="dbnote_update().change()">{{app.user.add.dbnote?'确认添加':'确认修改'}}</el-button>
                                            <el-button size="small" v-if="!app.user.add.dbnote" round type="danger" @click="dbnote_update().remove()">删除标签</el-button>
                                            <el-button size="small" round type="warning" @click="dbnote_update().default()">重置</el-button>
                                            <el-button size="small" round type="primary" @click="dbnote_update().back()">取消</el-button>
                                        </div>
                                    </div>
                                </transition>
                            </el-card>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var app = new Vue({
            el: '#main_app',
            data: {
                menu: {
                    isCollapse: true,
                },
                app: {
                    connect:true,
                    checkbox_group_value:{'FileRead':'文件读取','FileWrite':'文件写入','FileDelete':'文件删除','DirCreate':'创建目录','DirList':'列出目录','DirSubdirs':'列出子目录'},
                    page:1,
                    index: {
                        servers: [],
                        servers_dict: {},
                        changeinfo: { server_id: null, target: null, data: null, flag: true }
                    },
                    user:{
                        users:{
                            all:0,
                            servers:[],
                        },
                        search_user:{
                            server_id:null,
                            db_note:null,
                            user_keyword:null,
                        },
                        search_dbnote:{
                            server_id:null,
                            dbnote_keyword:null
                        },
                        search_props:{
                            value:"server_id",
                            label:"name",
                            children:'',
                            temp:null
                        },
                        servers:[],
                        select_user:null,
                        select_user_bak:null,
                        select_dbnote:null,
                        select_dbnote_bak:null,
                        loading:{
                            user_loading:0,
                            dbnote_loading:0,
                        },
                        user_tag_dialog:{
                            see:false,
                            value:null
                        },
                        dbnote_dialog:{
                            see:false,
                            value:null
                        },
                        add:{
                            user:false,
                            dbnote:false,
                        }
                    }
                }
            },
            methods: {
                change_page:function(key,keypath){
                    if(key==3){
                        self.$confirm('确认退出？', '警告', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }).then(_=>window.location.href='/ftpmanager/logout')
                        return
                    }
                    if(key<9)this.app.page=key;
                },
                menu_toggle: function () {
                    this.menu.isCollapse = !this.menu.isCollapse
                },
                dic_length: dic => Object.keys(dic).length,
                server_status_filter: function (status) {
                    return this.app.index.servers.filter(x => x.status == status)
                },
                toGB: zijie => (zijie / 1073741824).toFixed(2),
                changename: function () {
                    let self = this;
                    self.app.index.changeinfo.flag = false;
                    fetch_post('/ftpmanager/api/change_server_info', {
                        'server_id': self.app.index.changeinfo.server_id,
                        'target': 'name',
                        'data': self.app.index.changeinfo.data
                    }).then(res => {
                        self.app.index.changeinfo.flag = true;
                        if (!res.code == 0) {
                            self.$alert(res.err_msg, '异常操作', {
                                confirmButtonText: '确定',
                                type: 'error'
                            })
                        } else {
                            self.$message.success("修改成功");
                            self.app.index.changeinfo = { server_id: null, target: null, data: null, flag: true }
                        }
                    })
                },
                clear_index: function () {
                    this.app.index.changeinfo = { server_id: null, target: null, data: null, flag: true }
                },
                delete_server: function () {
                    let self = this
                    self.app.index.changeinfo.flag = false;
                    self.$confirm('此操作将会永久删除该服务器以及相关的用户记录，确认继续？', '警告', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        fetch_post('/ftpmanager/api/del_server', { 'server_id': this.app.index.changeinfo.server_id }).then(res => {
                            self.app.index.changeinfo.flag = true;
                            if (!res.code == 0) {
                                self.$alert(res.err_msg, '异常操作', {
                                    confirmButtonText: '确定',
                                    type: 'error'
                                })
                            } else {
                                self.$message.success("修改成功");
                                self.app.index.changeinfo = { server_id: null, target: null, data: null, flag: true };
                                window.location.href = window.location.href
                            }
                        })
                    })
                },
                load_dbnote:function(server_id){
                    let self=this
                    self.app.user.search_user.server_id=null
                    self.app.user.search_user.db_note=null
                    self.app.user.search_user.user_keyword=null
                    self.app.user.userlist=[]
                    if(server_id.length==0)return;
                    self.app.user.search_user.server_id=server_id[0]
                    if(server_id.length>1){
                        self.app.user.search_user.db_note=server_id[1]
                    }
                    self.get_users()
                    if(server_id.length>1)return;
                    server_id=server_id[0]
                    if(findObjectInList(self.app.user.servers,'server_id',server_id).children.length==0){
                        fetch_post('/ftpmanager/api/get_server_notes',{'server_id':server_id}).then(res=>{
                            if (!res.code == 0) {
                                self.$alert(res.err_msg, '异常操作', {
                                    confirmButtonText: '确定',
                                    type: 'error'
                                })
                                setTimeout(()=>window.location.href = window.location.href,3000)
                            } else {
                                let userlist=res.data.map(item=>{let tempitem={};tempitem['name']=item['name'],tempitem['server_id']=item['id'],tempitem['more']=item['more'];return tempitem})
                                for(let i=0;i<self.app.user.servers.length;i++){
                                    if(self.app.user.servers[i].server_id==server_id){
                                        self.app.user.servers[i].children=userlist || [];
                                        break;
                                    }
                                }
                            }
                        })
                    }
                },
                get_users:function(){
                    let self=this
                    //self.app.user.userlist=[]
                    self.app.user.loading.user_loading++
                    fetch_post('/ftpmanager/api/get_users',self.app.user.search_user).then(res=>{
                        if (!res.code == 0) {
                            self.$alert(res.err_msg, '异常操作', {
                                confirmButtonText: '确定',
                                type: 'error'
                            })
                        } else {
                            self.app.user.userlist=res.data
                        }
                    }).finally(
                        ()=>self.app.user.loading.user_loading--
                    )
                },
                get_user:function(row){
                    let self=this
                    self.app.user.loading.user_loading++
                    fetch_post('/ftpmanager/api/get_user',{'user_id':row.user_id}).then(res=>{
                        if (!res.code == 0) {
                            self.$alert(res.err_msg, '异常操作', {
                                confirmButtonText: '确定',
                                type: 'error'
                            })
                        } else {
                            if(!res.data.user_dbnote)res.data.user_dbnote=[];
                            self.app.user.select_user=deepCopy(res.data)
                            self.app.user.select_user_bak=deepCopy(res.data)
                        }
                    }).finally(
                        ()=>self.app.user.loading.user_loading--
                    )
                },
                get_dbnotes:function(){
                    let self=this
                    self.app.user.loading.dbnote_loading++
                    fetch_post('/ftpmanager/api/get_dbnotes',self.app.user.search_dbnote).then(res=>{
                        if (!res.code == 0) {
                            self.$alert(res.err_msg, '异常操作', {
                                confirmButtonText: '确定',
                                type: 'error'
                            })
                        } else {
                            if(!res.data)return;
                            res.data.map(e=>e.server_name=self.app.index.servers_dict[e.server_id].name || e.server_id)
                            self.app.user.dbnotelist=res.data
                        }
                    }).finally(
                        ()=>self.app.user.loading.dbnote_loading--
                    )
                },
                get_dbnote:function(row){
                    let self=this;
                    self.app.user.loading.dbnote_loading++;
                    fetch_post('/ftpmanager/api/get_dbnote',{'id':row.id}).then(res=>{
                        self.app.user.dbnote_dialog.see=true;
                        self.app.user.select_dbnote=deepCopy(res.data);
                        self.app.user.select_dbnote_bak=deepCopy(res.data);
                    }).finally(
                        ()=>self.app.user.loading.dbnote_loading--
                    )
                    
                },
                user_update:function(){
                    return {
                        change:()=>{
                            let self=this
                            let addTags=[]
                            let removeTags=[]
                            let a=self.app.user.select_user.user_dbnote.map(e=>e.id)
                            let b=self.app.user.select_user_bak.user_dbnote.map(e=>e.id)
                            for(let i of a)if(b.indexOf(i)==-1)addTags.push(i)
                            for(let i of b)if(a.indexOf(i)==-1)removeTags.push(i)
                            let change_pack={'user_id':self.app.user.select_user.user_info.user_id||null,'user_info':hasChanged(self.app.user.select_user_bak.user_info,self.app.user.select_user.user_info),'user_dbnote':{'addTags':addTags,'removeTags':removeTags}}
                            fetch_json('/ftpmanager/api/user_change',change_pack).then(res=>{
                                if (!res.code == 0) {
                                    self.$alert(res.err_msg, '异常操作', {
                                        confirmButtonText: '确定',
                                        type: 'error'
                                    })
                                    setTimeout(()=>window.location.href = window.location.href,3000)
                                } else {
                                    self.$message.success("修改成功");
                                    self.app.user.search_user.server_id=null;
                                    self.app.user.search_user.db_note=null;
                                    self.app.user.search_user.user_keyword=null;
                                    self.app.user.userlist=[];
                                    self.user_update().back();
                                    self.refresh_users_info();
                                }
                            })
                        },
                        remove:()=>{
                            let self=this;
                            self.$confirm('这将清除用户的所有信息','您确认删除用户吗',{
                                confirmButtonText:'确定',
                                cancelButtonText:'取消',
                                type:'warning'
                            }).then(()=>{
                                fetch_post('/ftpmanager/api/user_remove',{user_id:self.app.user.select_user.user_info.user_id}).then(res=>{
                                    if (!res.code == 0) {
                                    self.$alert(res.err_msg, '异常操作', {
                                        confirmButtonText: '确定',
                                        type: 'error'
                                    })
                                    setTimeout(()=>window.location.href = window.location.href,3000)
                                    } else {
                                        self.$message.success("删除成功");
                                        self.app.user.search_user.server_id=null;
                                        self.app.user.search_user.db_note=null;
                                        self.app.user.search_user.user_keyword=null;
                                        self.app.user.userlist=[];
                                        self.user_update().back();
                                        self.refresh_users_info();
                                    }
                                })
                            }).catch(()=>{})
                        },
                        default:()=>{
                            this.app.user.select_user=deepCopy(this.app.user.select_user_bak);
                        },
                        back:()=>{
                            this.app.user.add.user=false;
                            this.app.user.select_user_bak=null;
                            this.app.user.select_user=null;
                        },
                        remove_tag:(tag)=>{
                            let self=this;
                            self.app.user.select_user.user_dbnote.splice(self.app.user.select_user.user_dbnote.indexOf(tag),1);
                        },
                        add_tag:()=>{
                            let self=this;
                            let server_id=self.app.user.user_tag_dialog.value[0],dbnote_id=self.app.user.user_tag_dialog.value[1]
                            for(let i of self.app.user.servers){
                                if(i.server_id==server_id){
                                    for(let j of i.children){
                                        if(j.server_id==dbnote_id){
                                            for(let q of self.app.user.select_user.user_dbnote)if(q.id==dbnote_id){
                                                self.app.user.user_tag_dialog.see=false
                                                self.app.user.user_tag_dialog.value=[]
                                                return
                                            }
                                            self.app.user.select_user.user_dbnote.push({id:dbnote_id,name:j.name,server_id:server_id,more:j.more});
                                            break
                                        }
                                    }
                                }
                            }
                            self.app.user.user_tag_dialog.see=false
                            self.app.user.user_tag_dialog.value=[]
                        }
                    }
                },
                refresh_users_info:function(){
                    let self=this;
                        fetch_get('/ftpmanager/api/get_base_user_info').then(res=>{
                        self.app.user.users=res;
                    })
                },
                dbnote_update:function(){
                    return {
                        change:()=>{
                            let self=this;
                            if(!self.app.user.select_dbnote.id)self.app.user.select_dbnote.id=null;
                            fetch_json('/ftpmanager/api/dbnote_change',self.app.user.select_dbnote).then(res=>{
                                if (!res.code == 0) {
                                    self.$alert(res.err_msg, '异常操作', {
                                        confirmButtonText: '确定',
                                        type: 'error'
                                    })
                                } else {
                                    self.$message.success("更新成功");
                                    self.dbnote_update().back();
                                }
                            })
                        },
                        remove:()=>{
                            fetch_post('/ftpmanager/api/dbnote_remove', {'id':self.app.user.select_dbnote.id}).then(res => {
                                if (!res.code == 0) {
                                    self.$alert(res.err_msg, '异常操作', {
                                        confirmButtonText: '确定',
                                        type: 'error'
                                    })
                                } else {
                                    self.$message.success("删除成功");
                                    self.dbnote_update().back();
                                }
                            })
                        },
                        back:()=>{
                            let self=this;
                            this.app.user.add.dbnote=false;
                            this.app.user.select_dbnote=null;
                            this.app.user.select_dbnote_bak=null;
                        }
                    }
                }
            },
            computed: {
                sorted_service: function () {
                    let result = [];
                    for (let i of [1, 0, 2]) result.push(this.server_status_filter(i));
                    return result
                },
                server_by_status:function(){
                    let result=[];
                    for(let i of [1,0,2]){
                        let temp=this.server_status_filter(i);
                        for(let j in temp)result.push(temp[j]);
                    }
                    return result
                }
            },
            created: function () {
                self = this;
                fetch_get('/ftpmanager/api/async_info').then(res => {
                    let result=[];
                    for (let i in res) result.push(res[i]);
                    self.app.index.servers=result;
                    self.app.index.servers_dict = res;
                    let temp=[]
                    for(let i in res){
                        temp_one={}
                        temp_one['server_id']=i
                        temp_one['name']=res[i]['name']
                        temp_one['children']=[]
                        temp.push(temp_one)
                    }
                    self.app.user.servers=temp;
                })
                self.refresh_users_info();
                let just1=setInterval(() => {
                    fetch_get('/ftpmanager/api/async_info').then(res => {
                        let result=[];
                        for (let i in res) result.push(res[i]);
                        self.app.index.servers=result;
                        self.app.index.servers_dict = res;
                        let temp=[]
                        for(let i in res){
                            temp.push({'server_id':i,'name':res[i]['name'],'children':[]})
                        }
                        if(!isListObjectValueEqual(self.app.user.servers,temp,['server_id','name']))self.app.user.servers=temp
                    }).catch(_=>{
                        console.log(_)
                        clearInterval(just1);
                        self.app.connect=false;
                        self.$notify.error({
                            title:'发生了什么情况！',
                            message:'与服务器的连接断开了，是网络问题吗？要重新刷新试下吗？',
                            duration:0,
                        })
                        })
                }, 10000)
            },
        })
    </script>
</body>

</html>